<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36" version="29.2.3">
  <diagram name="Encryption-Decryption Workflow" id="eqoSESXkb20EhdVJS2zP">
    <mxGraphModel dx="3466" dy="2086" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-1" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" value="CryptShare E2E Encryption/Decryption Workflows" vertex="1">
          <mxGeometry height="40" width="800" x="400" y="20" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-2" parent="1" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontColor=#666666" value="AES-256-GCM | ECDH + HKDF for Key Derivation | Web Crypto API" vertex="1">
          <mxGeometry height="30" width="800" x="400" y="60" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-3" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=18;fontStyle=1" value="WORKFLOW 1: MESSAGE ENCRYPTION" vertex="1">
          <mxGeometry height="50" width="600" x="100" y="120" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-4" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1;align=center" value="Step 1: Derive Conversation Key" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="200" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-5" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: getOrCreateConversationKey()&#xa;&#xa;1. Check in-memory cache for existing key&#xa;2. If not cached:&#xa;   a. Retrieve my ECDH private key from IndexedDB&#xa;   b. Retrieve peer&#39;s ECDH public key from API/server&#xa;   c. Compute ECDH shared secret:&#xa;      sharedSecret = ECDH(myPrivate Ã— peerPublic)&#xa;   d. Derive persistent key using HKDF:&#xa;      conversationKey = HKDF-SHA256(&#xa;         ikm: sharedSecret,&#xa;         salt: SHA256(&#39;CryptShare-ConversationKey-v1&#39;),&#xa;         info: &#39;CryptShare-Conversation&#39;,&#xa;         output: AES-256-GCM key&#xa;      )&#xa;3. Cache key in memory for future use&#xa;&#xa;Result: AES-256-GCM key (persistent across sessions)" vertex="1">
          <mxGeometry height="260" width="600" x="100" y="240" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-6" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#82b366" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="400" y="540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-7" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;align=center" value="Step 2: Encrypt Message with AES-256-GCM" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="540" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-8" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: encryptMessage(conversationKey, plaintext)&#xa;&#xa;1. Generate fresh random IV (12 bytes)&#xa;   iv = crypto.getRandomValues(12)&#xa;   âš ï¸ CRITICAL: NEVER reuse IV with same key!&#xa;&#xa;2. Convert plaintext to bytes&#xa;   plaintextBuffer = TextEncoder.encode(plaintext)&#xa;&#xa;3. Encrypt with AES-256-GCM:&#xa;   ciphertext = AES-GCM-Encrypt(&#xa;      key: conversationKey,&#xa;      iv: iv,&#xa;      plaintext: plaintextBuffer,&#xa;      tagLength: 128 bits&#xa;   )&#xa;   â†“ Ciphertext includes 16-byte authentication tag&#xa;&#xa;4. Add replay protection:&#xa;   - Generate unique nonce (16 bytes)&#xa;   - Add timestamp (Date.now())&#xa;   - Add sequence number (per-conversation counter)&#xa;&#xa;5. Convert to base64 for transmission&#xa;&#xa;Output: { ciphertext, iv, nonce, timestamp, sequence }" vertex="1">
          <mxGeometry height="340" width="600" x="100" y="580" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-9" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#82b366" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="400" y="920" as="sourcePoint" />
            <mxPoint x="400" y="960" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-10" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;align=center" value="Step 3: Send Encrypted Message" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="960" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-11" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: socket.emit(&#39;message&#39;, data)&#xa;&#xa;1. Package encrypted data:&#xa;   {&#xa;     to: recipientId,&#xa;     from: senderId,&#xa;     ciphertext: base64String,&#xa;     iv: base64String,&#xa;     nonce: randomHex,&#xa;     timestamp: milliseconds,&#xa;     sequence: number&#xa;   }&#xa;&#xa;2. Send via Socket.IO to server&#xa;   â†’ Server CANNOT decrypt (no key)&#xa;   â†’ Server only relays to recipient&#xa;&#xa;3. Server validates replay protection:&#xa;   - Checks nonce uniqueness&#xa;   - Validates timestamp freshness (Â±5 min)&#xa;   - Verifies sequence number&#xa;&#xa;4. Server stores encrypted message in MongoDB&#xa;   (still encrypted, server cannot read)" vertex="1">
          <mxGeometry height="300" width="600" x="100" y="1000" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-12" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=18;fontStyle=1" value="WORKFLOW 2: MESSAGE DECRYPTION" vertex="1">
          <mxGeometry height="50" width="600" x="850" y="120" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-13" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=14;fontStyle=1;align=center" value="Step 1: Receive Encrypted Message" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="200" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-14" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Socket Listener: socket.on(&#39;message&#39;, callback)&#xa;&#xa;1. Receive encrypted message from server:&#xa;   {&#xa;     from: senderId,&#xa;     ciphertext: base64String,&#xa;     iv: base64String,&#xa;     nonce: randomHex,&#xa;     timestamp: milliseconds,&#xa;     sequence: number&#xa;   }&#xa;&#xa;2. Validate replay protection:&#xa;   a. Check if nonce already used (Set lookup)&#xa;   b. Validate timestamp (Â±5 min window)&#xa;   c. Verify sequence &gt; last received&#xa;   â†“ Reject if any check fails&#xa;&#xa;3. Mark nonce as used (prevent replay)" vertex="1">
          <mxGeometry height="260" width="600" x="850" y="240" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-15" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#b85450" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="1150" y="500" as="sourcePoint" />
            <mxPoint x="1150" y="540" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-16" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1;align=center" value="Step 2: Derive Same Conversation Key" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="540" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-17" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: getOrCreateConversationKey()&#xa;&#xa;SAME process as encryption Step 1:&#xa;&#xa;1. Check cache for sender&#39;s conversation key&#xa;2. If not cached:&#xa;   a. Get my ECDH private key from IndexedDB&#xa;   b. Get sender&#39;s ECDH public key from API&#xa;   c. Compute same shared secret:&#xa;      sharedSecret = ECDH(myPrivate Ã— senderPublic)&#xa;   d. Derive same persistent key:&#xa;      conversationKey = HKDF-SHA256(...)&#xa;&#xa;âœ“ Both parties derive IDENTICAL key&#xa;  (deterministic based on both users&#39; key pairs)" vertex="1">
          <mxGeometry height="240" width="600" x="850" y="580" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-18" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#b85450" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="1150" y="820" as="sourcePoint" />
            <mxPoint x="1150" y="860" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-19" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;align=center" value="Step 3: Decrypt with AES-256-GCM" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="860" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-20" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: decryptMessage(conversationKey, ciphertext, iv)&#xa;&#xa;1. Convert base64 to bytes:&#xa;   ciphertextBuffer = base64ToArray(ciphertext)&#xa;   ivBuffer = base64ToArray(iv)&#xa;&#xa;2. Decrypt with AES-256-GCM:&#xa;   plaintextBuffer = AES-GCM-Decrypt(&#xa;      key: conversationKey,&#xa;      iv: ivBuffer,&#xa;      ciphertext: ciphertextBuffer&#xa;   )&#xa;   â†“ Automatically verifies 16-byte auth tag&#xa;   â†“ Throws error if tampered or wrong key&#xa;&#xa;3. Convert bytes to text:&#xa;   plaintext = TextDecoder.decode(plaintextBuffer)&#xa;&#xa;4. Display to user&#xa;&#xa;ðŸ”’ GCM provides:&#xa;   â€¢ Confidentiality (encryption)&#xa;   â€¢ Authenticity (authentication tag)&#xa;   â€¢ Integrity (detects tampering)" vertex="1">
          <mxGeometry height="340" width="600" x="850" y="900" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-21" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=18;fontStyle=1" value="WORKFLOW 3: FILE ENCRYPTION &amp; UPLOAD" vertex="1">
          <mxGeometry height="50" width="600" x="100" y="1360" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-22" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1;align=center" value="Step 1: Read File into Memory" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="1440" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-23" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="const fileBuffer = await file.arrayBuffer()&#xa;&#xa;Load entire file into memory as ArrayBuffer&#xa;(For large files &gt;10MB, use chunked encryption)" vertex="1">
          <mxGeometry height="80" width="600" x="100" y="1480" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-24" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#82b366" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="400" y="1560" as="sourcePoint" />
            <mxPoint x="400" y="1600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-25" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;align=center" value="Step 2: Encrypt File with AES-256-GCM" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="1600" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-26" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: encryptFile(conversationKey, file)&#xa;&#xa;1. Generate fresh IV (12 bytes)&#xa;   iv = crypto.getRandomValues(12)&#xa;&#xa;2. Encrypt file buffer:&#xa;   encryptedBuffer = AES-GCM-Encrypt(&#xa;      key: conversationKey,&#xa;      iv: iv,&#xa;      data: fileBuffer&#xa;   )&#xa;&#xa;3. Store metadata:&#xa;   {&#xa;     name: file.name,&#xa;     type: file.type (MIME),&#xa;     size: originalSize,&#xa;     encryptedSize: encryptedBuffer.length&#xa;   }&#xa;&#xa;Result: { encryptedData, iv, metadata }" vertex="1">
          <mxGeometry height="280" width="600" x="100" y="1640" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-27" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#82b366" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="400" y="1920" as="sourcePoint" />
            <mxPoint x="400" y="1960" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-28" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;align=center" value="Step 3: Upload to Server" vertex="1">
          <mxGeometry height="40" width="600" x="100" y="1960" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-29" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="POST /api/files/upload&#xa;&#xa;FormData:&#xa;  - file: encryptedData (binary)&#xa;  - iv: base64String&#xa;  - metadata: JSON { name, type, size }&#xa;  - recipientId: userId&#xa;&#xa;Server:&#xa;  1. Saves encrypted file to disk (uploads/ folder)&#xa;  2. Stores file record in MongoDB:&#xa;     - sender, recipient, fileId&#xa;     - encrypted filename, size, iv&#xa;     - Server CANNOT decrypt file&#xa;  3. Returns fileId&#xa;&#xa;Notify recipient via Socket:&#xa;  socket.emit(&#39;file_shared&#39;, { fileId, metadata })" vertex="1">
          <mxGeometry height="280" width="600" x="100" y="2000" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-30" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=18;fontStyle=1" value="WORKFLOW 4: FILE DOWNLOAD &amp; DECRYPTION" vertex="1">
          <mxGeometry height="50" width="600" x="850" y="1360" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-31" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=14;fontStyle=1;align=center" value="Step 1: Download Encrypted File" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="1440" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-32" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="GET /api/files/download/:fileId&#xa;&#xa;1. Fetch file metadata from MongoDB&#xa;   { name, type, size, iv, encryptedPath }&#xa;&#xa;2. Download encrypted file from server&#xa;   encryptedData = await fetch(fileUrl).arrayBuffer()&#xa;&#xa;3. Server sends encrypted file (cannot decrypt)" vertex="1">
          <mxGeometry height="140" width="600" x="850" y="1480" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-33" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#b85450" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="1150" y="1620" as="sourcePoint" />
            <mxPoint x="1150" y="1660" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-34" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1;align=center" value="Step 2: Derive Conversation Key" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="1660" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-35" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Same as message decryption:&#xa;conversationKey = getOrCreateConversationKey(senderId)" vertex="1">
          <mxGeometry height="60" width="600" x="850" y="1700" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-36" edge="1" parent="1" style="endArrow=classic;html=1;strokeWidth=3;strokeColor=#b85450" value="">
          <mxGeometry height="50" relative="1" width="50" as="geometry">
            <mxPoint x="1150" y="1760" as="sourcePoint" />
            <mxPoint x="1150" y="1800" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-37" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;align=center" value="Step 3: Decrypt File" vertex="1">
          <mxGeometry height="40" width="600" x="850" y="1800" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-38" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Function: decryptFile(conversationKey, encryptedData, iv)&#xa;&#xa;1. Decrypt with AES-256-GCM:&#xa;   decryptedBuffer = AES-GCM-Decrypt(&#xa;      key: conversationKey,&#xa;      iv: iv,&#xa;      ciphertext: encryptedData&#xa;   )&#xa;&#xa;2. Create downloadable blob:&#xa;   blob = new Blob([decryptedBuffer], { type: mimeType })&#xa;   url = URL.createObjectURL(blob)&#xa;&#xa;3. Trigger browser download:&#xa;   a.href = url&#xa;   a.download = originalFileName&#xa;   a.click()&#xa;&#xa;âœ“ File decrypted client-side only&#xa;âœ“ Server never sees plaintext" vertex="1">
          <mxGeometry height="280" width="600" x="850" y="1840" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-39" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=18;fontStyle=1" value="KEY DERIVATION ARCHITECTURE" vertex="1">
          <mxGeometry height="50" width="1350" x="100" y="2340" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-40" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1" value="Two Key Types Used" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="2420" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-41" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=14;fontStyle=1;align=center" value="1. CONVERSATION KEYS (Persistent)" vertex="1">
          <mxGeometry height="40" width="650" x="100" y="2480" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-42" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Purpose: Encrypt/decrypt messages and files&#xa;&#xa;Derivation:&#xa;  conversationKey = HKDF-SHA256(&#xa;     ikm: ECDH(myPrivateKey Ã— peerPublicKey),&#xa;     salt: SHA256(&#39;CryptShare-ConversationKey-v1&#39;),&#xa;     info: &#39;CryptShare-Conversation&#39;,&#xa;     output: AES-256-GCM key&#xa;  )&#xa;&#xa;Properties:&#xa;  âœ“ Persistent: Same key for same user pair&#xa;  âœ“ Deterministic: Always produces same key&#xa;  âœ“ Bidirectional: Both users derive identical key&#xa;  âœ“ Cached in memory for performance&#xa;  âœ“ Used for: Message history, file sharing&#xa;&#xa;Storage:&#xa;  â€¢ Private keys in IndexedDB (client-side only)&#xa;  â€¢ Derived keys cached in memory&#xa;  â€¢ Never transmitted over network&#xa;&#xa;Use Case:&#xa;  - Decrypt old messages after login&#xa;  - Share files in conversation&#xa;  - Maintain message history" vertex="1">
          <mxGeometry height="400" width="650" x="100" y="2520" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-43" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;align=center" value="2. SESSION KEYS (Ephemeral)" vertex="1">
          <mxGeometry height="40" width="650" x="800" y="2480" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-44" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;verticalAlign=top;spacingLeft=20;fontSize=11;fontFamily=Monospace" value="Purpose: Extra security layer via key exchange protocol&#xa;&#xa;Derivation:&#xa;  sessionKey = HKDF-SHA256(&#xa;     ikm: ECDH(ephemeralPrivate Ã— ephemeralPublic),&#xa;     salt: SHA256(nonce1 || nonce2 || version),&#xa;     info: &#39;CryptShare-Session:AliceID:BobID&#39;,&#xa;     output: AES-256-GCM key&#xa;  )&#xa;&#xa;Properties:&#xa;  âœ“ Ephemeral: New key per session&#xa;  âœ“ Forward Secrecy: Old messages safe if key compromised&#xa;  âœ“ Temporary: Derived from ephemeral ECDH keys&#xa;  âœ“ Authenticated: Signed with long-term ECDSA keys&#xa;  âœ“ Used for: Real-time chat session&#xa;&#xa;Lifecycle:&#xa;  1. Generated during CryptShare-KEX protocol&#xa;  2. Both parties derive via 3-message exchange&#xa;  3. Stored in sessionStorage (cleared on close)&#xa;  4. Discarded after session ends&#xa;&#xa;Use Case:&#xa;  - Real-time secure communication&#xa;  - Forward secrecy guarantee&#xa;  - Protection against key compromise" vertex="1">
          <mxGeometry height="400" width="650" x="800" y="2520" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-45" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=18;fontStyle=1" value="SECURITY FEATURES" vertex="1">
          <mxGeometry height="50" width="1350" x="100" y="2960" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-46" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=13;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10" value="ðŸ” End-to-End Encryption" vertex="1">
          <mxGeometry height="180" width="310" x="100" y="3030" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-47" parent="1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=none;align=left;verticalAlign=top;spacingLeft=10;fontSize=11" value="â€¢ Server never has decryption keys&#xa;â€¢ Private keys stored locally&#xa;  (IndexedDB)&#xa;â€¢ Keys never leave client&#xa;â€¢ AES-256-GCM for encryption&#xa;â€¢ 256-bit key strength&#xa;â€¢ Zero-knowledge architecture" vertex="1">
          <mxGeometry height="140" width="290" x="110" y="3060" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-48" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=13;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10" value="ðŸ›¡ï¸ Replay Attack Protection" vertex="1">
          <mxGeometry height="180" width="310" x="440" y="3030" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-49" parent="1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=none;align=left;verticalAlign=top;spacingLeft=10;fontSize=11" value="Triple-layer protection:&#xa;1. Unique nonce (16 bytes)&#xa;2. Timestamp validation&#xa;   (Â±5 min window)&#xa;3. Sequence numbers&#xa;   (per-conversation)&#xa;â€¢ Server validates all layers&#xa;â€¢ Detected attacks logged" vertex="1">
          <mxGeometry height="140" width="290" x="450" y="3060" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-50" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=13;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10" value="ðŸ”‘ Forward Secrecy" vertex="1">
          <mxGeometry height="180" width="310" x="780" y="3030" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-51" parent="1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=none;align=left;verticalAlign=top;spacingLeft=10;fontSize=11" value="â€¢ Ephemeral ECDH keys&#xa;â€¢ New session key per chat&#xa;â€¢ Old messages safe even if&#xa;  current key compromised&#xa;â€¢ Session keys discarded&#xa;  after use&#xa;â€¢ No persistent session keys" vertex="1">
          <mxGeometry height="140" width="290" x="790" y="3060" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-52" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=13;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10" value="âœ… Authentication &amp; Integrity" vertex="1">
          <mxGeometry height="180" width="330" x="1120" y="3030" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-53" parent="1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=none;align=left;verticalAlign=top;spacingLeft=10;fontSize=11" value="â€¢ GCM authentication tag&#xa;  (128 bits)&#xa;â€¢ Detects any tampering&#xa;â€¢ ECDSA signatures on KEX&#xa;â€¢ Mutual authentication&#xa;â€¢ MITM attack prevention&#xa;â€¢ Message integrity guaranteed" vertex="1">
          <mxGeometry height="140" width="310" x="1130" y="3060" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-54" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=18;fontStyle=1" value="CRYPTOGRAPHIC STACK" vertex="1">
          <mxGeometry height="50" width="1350" x="100" y="3250" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-55" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=13;fontStyle=1" value="Encryption: AES-256-GCM" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="3320" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-56" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=13;fontStyle=1" value="Key Exchange: ECDH P-256" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="3370" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-57" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=13;fontStyle=1" value="Signatures: ECDSA P-256 + SHA-256" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="3420" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-58" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=13;fontStyle=1" value="Key Derivation: HKDF-SHA256" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="3470" as="geometry" />
        </mxCell>
        <mxCell id="VgKiRV9WyVlPn5Ewbenx-59" parent="1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=13;fontStyle=1" value="Implementation: Web Crypto API (Browser Native)" vertex="1">
          <mxGeometry height="40" width="1350" x="100" y="3520" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
